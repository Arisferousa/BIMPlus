<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f0f0; }
        .container { display: flex; flex-direction: column; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* The Beam Preview Styling */
        #preview-box { display: flex; justify-content: center; align-items: center; background: #333; padding: 20px; border-radius: 8px; }
        svg { background: #444; border: 2px dashed #666; }
        .rebar { fill: #ff5555; stroke: white; stroke-width: 1px; }
        .stirrup { fill: none; stroke: #00aaff; stroke-width: 2px; }

        .input-group { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
        label { font-size: 14px; font-weight: bold; color: #555; }
        input, select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; width: 60px;}
        select { width: 150px; }
        
        button { background-color: #0078D7; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px;}
        button:hover { background-color: #005a9e; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="card" id="preview-box">
        <svg id="beamSvg" width="200" height="300" viewBox="0 0 400 600">
            <rect x="50" y="50" width="300" height="500" fill="#bbb" stroke="none" />
            <rect x="70" y="70" width="260" height="460" class="stirrup" rx="10" />
            <g id="grp-top"></g>
            <g id="grp-bottom"></g>
            <g id="grp-side"></g>
        </svg>
    </div>

    <div class="card">
        <h3>Configuration</h3>
        
        <div class="input-group">
            <label>Rebar Type</label>
            <select id="rebarType"></select>
        </div>

        <div class="input-group">
            <label>Top Count</label>
            <input type="number" id="topCount" value="3" min="2" oninput="updatePreview()">
        </div>

        <div class="input-group">
            <label>Bottom Count</label>
            <input type="number" id="btmCount" value="3" min="2" oninput="updatePreview()">
        </div>

        <div class="input-group">
            <label>Side (Left/Right)</label>
            <input type="number" id="sideCount" value="1" min="0" oninput="updatePreview()">
        </div>
    </div>

    <button onclick="sendDataToRevit()">Create Rebar</button>
</div>

<script>
    // --- 1. POPULATE DATA ---
    // Python will call this function to fill the dropdown
    function setRebarTypes(typesJson) {
        const types = JSON.parse(typesJson);
        const select = document.getElementById('rebarType');
        types.forEach(t => {
            let opt = document.createElement('option');
            opt.value = t.id;
            opt.innerHTML = t.name;
            select.appendChild(opt);
        });
    }

    // --- 2. PREVIEW LOGIC (The Math) ---
    function updatePreview() {
        const topN = parseInt(document.getElementById('topCount').value);
        const btmN = parseInt(document.getElementById('btmCount').value);
        const sideN = parseInt(document.getElementById('sideCount').value);
        
        drawRebarRow('grp-top', topN, 85, 300, 85); // y = 85 (top)
        drawRebarRow('grp-bottom', btmN, 85, 300, 515); // y = 515 (bottom)
        drawSideRebar('grp-side', sideN, 85, 515, 85, 315); // distribute vertically
    }

    function drawRebarRow(groupId, count, xStart, xEnd, yPos) {
        const container = document.getElementById(groupId);
        container.innerHTML = ''; // clear old
        if (count < 1) return;

        const width = xEnd - xStart;
        // If count is 1, center it. Else distribute.
        const gap = count > 1 ? width / (count - 1) : 0;

        for (let i = 0; i < count; i++) {
            let cx = count > 1 ? xStart + (gap * i) : xStart + (width/2);
            let circle = `<circle cx="${cx}" cy="${yPos}" r="12" class="rebar" />`;
            container.innerHTML += circle;
        }
    }

    function drawSideRebar(groupId, count, yTop, yBtm, xLeft, xRight) {
        const container = document.getElementById(groupId);
        container.innerHTML = ''; 
        if (count < 1) return;

        const height = yBtm - yTop;
        // Distribute strictly between top and bottom bars
        const step = height / (count + 1);

        for (let i = 1; i <= count; i++) {
            let cy = yTop + (step * i);
            // Left Bar
            container.innerHTML += `<circle cx="${xLeft}" cy="${cy}" r="12" class="rebar" />`;
            // Right Bar
            container.innerHTML += `<circle cx="${xRight}" cy="${cy}" r="12" class="rebar" />`;
        }
    }

    // --- 3. SEND TO REVIT ---
    function sendDataToRevit() {
        const data = {
            rebarId: document.getElementById('rebarType').value,
            top: document.getElementById('topCount').value,
            bottom: document.getElementById('btmCount').value,
            side: document.getElementById('sideCount').value
        };
        
        // This changes the URL, which Python detects
        window.location = 'pyrevit://create_rebar/' + encodeURIComponent(JSON.stringify(data));
    }

    // Init with default
    updatePreview();
</script>
</body>
</html>